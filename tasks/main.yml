---
- name: Create default user
  user:
    name: "{{ item }}"
    comment: This user has been provisioned by Megacorp
    uid: 1069
    group: wheel
  loop: "{{ USERS }}"

- name: Install simple software without any additional configuration
  community.general.rpm_ostree_pkg:
    name: 
      - podman-compose
      - htop
      - tldr
    state: present

- name: Install virtualization packages
  community.general.rpm_ostree_pkg:
    name: 
      - libvirt-daemon-config-network
      - libvirt-daemon-kvm
      - qemu-kvm
      - virt-install
      - virt-manager
      - virt-viewer
    state: present
  when: INSTALL_VIRTUALIZATION

- name: Install and configure zsh shell
  block:
    - name: Install zsh
      community.general.rpm_ostree_pkg:
        name: zsh
        state: present
    - name: Make ohmyzsh git directory safe
      command: git config --global --add safe.directory /var/home/{{ item }}/.oh-my-zsh
      check_mode: no
      loop: "{{ USERS }}"
    - name: Clone ohmyzsh repo
      git:
        repo: "https://github.com/ohmyzsh/ohmyzsh.git"
        dest: /var/home/{{ item }}/.oh-my-zsh
      loop: "{{ USERS }}"
    - name: Copy zsh config
      copy:
        src: files/zshrc/.zshrc
        dest: /var/home/{{ item }}
      loop: "{{ USERS }}"
    - name: Fix file permission on zsh config
      file:
        path: /var/home/{{ item }}/.zshrc
        owner: "{{ item }}"
        group: "{{ item }}"
      loop: "{{ USERS }}"
    - name: Fix file permissions on oh-my-zsh folder
      file:
        path: /var/home/{{ item }}/.oh-my-zsh
        recurse: true
        owner: "{{ item }}"
        group: "{{ item }}"
      loop: "{{ USERS }}"
    - name: Change default shell
      user:
        name: "{{ item }}"
        shell: /bin/zsh
      loop: "{{ USERS }}"
  when: INSTALL_ZSH

- name: Install and configure tmux
  block:
    - name: Install tmux
      community.general.rpm_ostree_pkg:
        name: tmux
        state: present
    - name: Make tmux git directory safe
      command: git config --global --add safe.directory /var/home/{{ item }}/.tmux
      check_mode: no
      loop: "{{ USERS }}"
    - name: Download pretty tmux from git
      git:
        repo: "https://github.com/gpakosz/.tmux.git"
        dest: /var/home/{{ item }}/.tmux
      loop: "{{ USERS }}"
    - name: Fix file permissions for tmux
      file:
        path: /var/home/{{ item }}/.tmux
        owner: "{{ item }}"
        group: "{{ item }}"
      loop: "{{ USERS }}"
    - name: Copy local tmux config to home dir
      command: cp .tmux/.tmux.conf.local .
      args:
        chdir: /var/home/{{ item }}
      loop: "{{ USERS }}"
    - name: Create tmux config symlink
      command: ln -s -f .tmux/.tmux.conf
      args:
        chdir: /var/home/{{ item }}
      loop: "{{ USERS }}"
  when: INSTALL_TMUX

- name: Install and configure nvim
  block:
    - name: Install nvim and ripgrep
      community.general.rpm_ostree_pkg:
        name: 
          - neovim
          - ripgrep
        state: present
    - name: Make nvim git directory safe
      command: git config --global --add safe.directory /var/home/{{ item }}/.config/nvim
      check_mode: no
      loop: "{{ USERS }}"
    - name: Download nvchad from git
      git:
        repo: https://github.com/nvchad/nvchad
        depth: 1
        dest: /var/home/{{ item }}/.config/nvim
      loop: "{{ USERS }}"
    - name: Fix permissions on nvim dir
      file:
        path: /var/home/{{ item }}/.config
        recurse: true
        owner: "{{ item }}"
        group: "{{ item }}"
      loop: "{{ USERS }}"
    - name: Create fonts directory if it doesn't exist
      file:
        path: /var/home/{{ item }}/.local/share/fonts
        state: directory
      loop: "{{ USERS }}"
    - name: Downloaded Terminus font from github
      unarchive:
        src: https://github.com/ryanoasis/nerd-fonts/releases/download/v3.0.1/Terminus.zip
        dest: /var/home/{{ item }}/.local/share/fonts
        remote_src: true
      loop: "{{ USERS }}"
  when: INSTALL_VIM

- name: Configure MOTD
  block:
    - name: Install neofetch
      community.general.rpm_ostree_pkg:
        name: neofetch
        state: present
    - name: Ensure .config file exists
      file:
        path: /var/home/{{ item }}/.config/neofetch
        state: directory
      loop: "{{ USERS }}"
    - name: Copy neofetch config
      copy:
        src: files/neofetch/config.conf
        dest: /var/home/{{ item }}/.config/neofetch/
      loop: "{{ USERS }}"
    - name: Copy megacorplogo
      copy:
        src: files/neofetch/megacorplogo
        dest: /var/home/{{ item }}/.config/neofetch/
      loop: "{{ USERS }}"
    - name: Fix permissions on .config dir
      file:
        path: /var/home/{{ item }}/.config/neofetch
        recurse: true
        owner: "{{ item }}"
        group: "{{ item }}"
      loop: "{{ USERS }}"

